\hypertarget{_c_arl___f_e_t_i__setup__finish_8cpp}{}\section{/\+Users/breubreubreu/\+Programming/\+C\+Arl/\+Cpp/src/execs/\+C\+Arl\+\_\+\+F\+E\+T\+I/\+C\+Arl\+\_\+\+F\+E\+T\+I\+\_\+setup\+\_\+finish.cpp File Reference}
\label{_c_arl___f_e_t_i__setup__finish_8cpp}\index{/\+Users/breubreubreu/\+Programming/\+C\+Arl/\+Cpp/src/execs/\+C\+Arl\+\_\+\+F\+E\+T\+I/\+C\+Arl\+\_\+\+F\+E\+T\+I\+\_\+setup\+\_\+finish.\+cpp@{/\+Users/breubreubreu/\+Programming/\+C\+Arl/\+Cpp/src/execs/\+C\+Arl\+\_\+\+F\+E\+T\+I/\+C\+Arl\+\_\+\+F\+E\+T\+I\+\_\+setup\+\_\+finish.\+cpp}}
{\ttfamily \#include \char`\"{}C\+Arl\+\_\+\+F\+E\+T\+I\+\_\+setup\+\_\+finish.\+h\char`\"{}}\\*
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
int \hyperlink{_c_arl___f_e_t_i__setup__finish_8cpp_a3c04138a5bfe5d72780bb7e82a18e627}{main} (int argc, char $\ast$$\ast$argv)
\begin{DoxyCompactList}\small\item\em Program responsible to finish the F\+E\+T\+I setup and launch the iterations. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Function Documentation}
\hypertarget{_c_arl___f_e_t_i__setup__finish_8cpp_a3c04138a5bfe5d72780bb7e82a18e627}{}\index{C\+Arl\+\_\+\+F\+E\+T\+I\+\_\+setup\+\_\+finish.\+cpp@{C\+Arl\+\_\+\+F\+E\+T\+I\+\_\+setup\+\_\+finish.\+cpp}!main@{main}}
\index{main@{main}!C\+Arl\+\_\+\+F\+E\+T\+I\+\_\+setup\+\_\+finish.\+cpp@{C\+Arl\+\_\+\+F\+E\+T\+I\+\_\+setup\+\_\+finish.\+cpp}}
\subsubsection[{main(int argc, char $\ast$$\ast$argv)}]{\setlength{\rightskip}{0pt plus 5cm}int main (
\begin{DoxyParamCaption}
\item[{int}]{argc, }
\item[{char $\ast$$\ast$}]{argv}
\end{DoxyParamCaption}
)}\label{_c_arl___f_e_t_i__setup__finish_8cpp_a3c04138a5bfe5d72780bb7e82a18e627}


Program responsible to finish the F\+E\+T\+I setup and launch the iterations. 

This program\textquotesingle{}s input file description can be found at the documentation of the function \hyperlink{namespacecarl_afe02e73d82d3c09395afe0e786840369}{carl\+::get\+\_\+input\+\_\+params(\+Get\+Pot\& field\+\_\+parser, feti\+\_\+setup\+\_\+finish\+\_\+params\& input\+\_\+params)}.

It will use the following files ...
\begin{DoxyItemize}
\item ... from the {\ttfamily input\+\_\+params.\+coupling\+\_\+folder\+\_\+path} folder\+:
\begin{DoxyItemize}
\item coupling matrices C\+\_\+1, C\+\_\+2 and C\+\_\+\+M (the latter used for the preconditioner). {\itshape Files}\+:
\begin{DoxyItemize}
\item {\ttfamily coupling\+\_\+matrix\+\_\+macro.\+petscmat}
\item {\ttfamily coupling\+\_\+matrix\+\_\+micro.\+petscmat}
\item {\ttfamily coupling\+\_\+matrix\+\_\+mediator.\+petscmat}
\end{DoxyItemize}
\end{DoxyItemize}
\item ... from the {\ttfamily input\+\_\+params.\+scratch\+\_\+folder\+\_\+path} folder\+:
\begin{DoxyItemize}
\item solutions u\+\_\+0,1 and u\+\_\+0,2, from the system K\+\_\+i $\ast$ u\+\_\+0,i = F\+\_\+i. {\itshape Files}\+:
\begin{DoxyItemize}
\item {\ttfamily ext\+\_\+solver\+\_\+u0\+\_\+\+A\+\_\+sys\+\_\+sol\+\_\+vec.\+petscvec}
\item {\ttfamily ext\+\_\+solver\+\_\+u0\+\_\+\+B\+\_\+sys\+\_\+sol\+\_\+vec.\+petscvec}
\end{DoxyItemize}
\item solutions x\+\_\+1(kkk) and x\+\_\+2(kkk), from the system K\+\_\+i $\ast$ x\+\_\+i(kkk) = C\+\_\+i$^\wedge$\+T$\ast$phi\+\_\+0. {\itshape Files}\+:
\begin{DoxyItemize}
\item \mbox{[}R\+B\mbox{]} {\ttfamily ext\+\_\+solver\+\_\+\+A\+\_\+sys\+\_\+sol\+\_\+vec.\+petscvec}
\item \mbox{[}R\+B\mbox{]} {\ttfamily ext\+\_\+solver\+\_\+\+B\+\_\+sys\+\_\+sol\+\_\+vec.\+petscvec}
\end{DoxyItemize}
\item matrix inv (R\+\_\+\+I$^\wedge$t $\ast$ R\+\_\+\+I) = inv(\+R\+\_\+2$^\wedge$t$\ast$\+C\+\_\+2$^\wedge$t$\ast$\+C\+\_\+2$\ast$\+R\+\_\+2), used for the rigid body modes projections. {\itshape Files}\+:
\begin{DoxyItemize}
\item \mbox{[}R\+B\mbox{]} {\ttfamily rb\+\_\+inv\+\_\+\+R\+I\+T\+R\+I.\+petscmat}.
\end{DoxyItemize}
\item rigid body mode vectors multiplied by C\+\_\+2. {\itshape Files}\+:
\begin{DoxyItemize}
\item \mbox{[}R\+B\mbox{]} {\ttfamily rb\+\_\+coupl\+\_\+vector\+\_\+\mbox{[}iii\mbox{]}\+\_\+n\+\_\+\mbox{[}nb. of vectors\mbox{]}.petscvec}
\end{DoxyItemize}
\end{DoxyItemize}
\item ... from the micro system folder (common vector path given by {\ttfamily input\+\_\+params.\+R\+B\+\_\+vectors\+\_\+base})\+:
\begin{DoxyItemize}
\item rigid body mode vectors. {\itshape Files}\+:
\begin{DoxyItemize}
\item \mbox{[}R\+B\mbox{]} {\ttfamily \mbox{[}input\+\_\+params.\+R\+B\+\_\+vectors\+\_\+base\mbox{]}\+\_\+rb\+\_\+vector\+\_\+\mbox{[}iii\mbox{]}\+\_\+n\+\_\+\mbox{[}nb. of vectors\mbox{]}.petscvec}
\end{DoxyItemize}
\end{DoxyItemize}
\end{DoxyItemize}

The items marked with a \mbox{[}R\+B\mbox{]} are only needed if the rigid body modes projectors are used. In the last two cases, \mbox{[}nb. of vectors\mbox{]} is the number of rigid body mode vectors (given by {\ttfamily input\+\_\+params.\+nb\+\_\+of\+\_\+rb\+\_\+vectors}) and \mbox{[}iii\mbox{]} is an integer going from 0 to {\ttfamily input\+\_\+params.\+nb\+\_\+of\+\_\+rb\+\_\+vectors -\/ 1} (following C++ notation).

This program outputs a series of files, all inside the {\ttfamily input\+\_\+params.\+scratch\+\_\+folder\+\_\+path} folder\+:
\begin{DoxyItemize}
\item initial iteration vectors, r(0), z(0), p(0). {\itshape Files}\+:
\begin{DoxyItemize}
\item {\ttfamily F\+E\+T\+I\+\_\+iter\+\_\+\+\_\+r\+\_\+\+\_\+0.\+petscvec}
\item {\ttfamily F\+E\+T\+I\+\_\+iter\+\_\+\+\_\+p\+\_\+\+\_\+0.\+petscvec}
\end{DoxyItemize}
\item (overwrite) vectors used as the R\+H\+S for the external solvers. {\itshape Files}\+:
\begin{DoxyItemize}
\item {\ttfamily ext\+\_\+solver\+\_\+\+A\+\_\+rhs.\+petscvec}
\item {\ttfamily ext\+\_\+solver\+\_\+\+B\+\_\+rhs.\+petscvec}
\end{DoxyItemize}
\item (create) scalar values (iteration, residual, R\+B mode corrections). {\itshape Files}\+:
\begin{DoxyItemize}
\item {\ttfamily F\+E\+T\+I\+\_\+iter\+\_\+scalar\+\_\+data.\+dat} 
\end{DoxyItemize}
\end{DoxyItemize}

Definition at line 45 of file C\+Arl\+\_\+\+F\+E\+T\+I\+\_\+setup\+\_\+finish.\+cpp.


\begin{DoxyCode}
45                                 \{
46 
47     \textcolor{comment}{// --- Initialize libMesh}
48     libMesh::LibMeshInit init(argc, argv);
49 
50     \textcolor{comment}{// Do performance log?}
51     libMesh::PerfLog perf\_log(\textcolor{stringliteral}{"Main program"});
52 
53     \textcolor{comment}{// libMesh's C++ / MPI communicator wrapper}
54     libMesh::Parallel::Communicator& WorldComm = init.comm();
55 
56     \textcolor{comment}{// Number of processors and processor rank.}
57     \textcolor{keywordtype}{int} rank = WorldComm.rank();
58     \textcolor{keywordtype}{int} nodes = WorldComm.size();
59 
60     \textcolor{comment}{// --- Set up inputs}
61 
62     \textcolor{comment}{// Command line parser}
63     GetPot command\_line(argc, argv);
64 
65     \textcolor{comment}{// File parser}
66     GetPot field\_parser;
67 
68     \textcolor{comment}{// If there is an input file, parse it to get the parameters. Else, parse the command line}
69     std::string input\_filename;
70     \textcolor{keywordflow}{if} (command\_line.search(2, \textcolor{stringliteral}{"--inputfile"}, \textcolor{stringliteral}{"-i"})) \{
71         input\_filename = command\_line.next(input\_filename);
72         field\_parser.parse\_input\_file(input\_filename, \textcolor{stringliteral}{"#"}, \textcolor{stringliteral}{"\(\backslash\)n"}, \textcolor{stringliteral}{" \(\backslash\)t\(\backslash\)n"});
73     \} \textcolor{keywordflow}{else} \{
74         field\_parser = command\_line;
75     \}
76 
77     \hyperlink{structcarl_1_1feti__setup__finish__params}{carl::feti\_setup\_finish\_params} input\_params;
78     \hyperlink{namespacecarl_a902f88f3c52c6fc9c974bc99832e78a7}{get\_input\_params}(field\_parser, input\_params);
79 
80     \textcolor{comment}{// Object containing the FETI operations}
81     \hyperlink{classcarl_1_1_f_e_t_i___operations}{carl::FETI\_Operations} feti\_op(WorldComm,input\_params.
      \hyperlink{structcarl_1_1feti__setup__finish__params_ac8490d7133284997e9497f13c75ed1bd}{scratch\_folder\_path},input\_params.\hyperlink{structcarl_1_1feti__setup__finish__params_aebb6a453ba760ab225a75d6b4e96fa75}{coupling\_folder\_path});
82 
83     \textcolor{comment}{// --- Define if the rb modes will be used or not}
84     feti\_op.using\_rb\_modes(input\_params.\hyperlink{structcarl_1_1feti__setup__finish__params_a4226249254863225438b36c9c2f47615}{bUseRigidBodyModes});
85 
86     \textcolor{comment}{// --- Read the files!}
87 
88     \textcolor{comment}{// Read up the coupling matricesconst std::string& filename)}
89     feti\_op.set\_coupling\_matrix\_R\_micro();
90     feti\_op.set\_coupling\_matrix\_R\_BIG();
91 
92     \textcolor{comment}{// Read the decoupled solutions, K\_i * u\_0,i  = F\_i }
93     feti\_op.read\_decoupled\_solutions();
94 
95     \textcolor{comment}{// Read operations needed if we are using the rigid body modes}
96     \textcolor{keywordflow}{if}(input\_params.\hyperlink{structcarl_1_1feti__setup__finish__params_a4226249254863225438b36c9c2f47615}{bUseRigidBodyModes})
97     \{
98         \textcolor{comment}{// Read the solutions of K\_i * x\_i(0)  = C\_i^T * phi(0)}
99         feti\_op.read\_ext\_solver\_output();
100 
101         \textcolor{comment}{// Read the RB-related vectors and matrices}
102         feti\_op.read\_null\_space\_vecs(input\_params.\hyperlink{structcarl_1_1feti__setup__finish__params_aebec4649657ad7602a20111ffdb01e06}{RB\_vectors\_base},input\_params.
      \hyperlink{structcarl_1_1feti__setup__finish__params_a3fea6d0b9c2825b61e90714790c716de}{nb\_of\_rb\_vectors});
103         feti\_op.read\_null\_space\_inv\_RITRI\_mat();
104     \}
105 
106     \textcolor{comment}{// --- Set up any matrices or vectors needed before calculating the outputs}
107     \textcolor{comment}{// Set up the preconditioner}
108     feti\_op.set\_preconditioner(input\_params.\hyperlink{structcarl_1_1feti__setup__finish__params_ad5b14913a3808cee9a058d7a90c4ee5e}{CG\_precond\_type} \textcolor{comment}{/*, initial\_set = true */} );
109 
110     \textcolor{comment}{// --- Calculate the output vectors! All are saved internaly inside the object}
111     \textcolor{comment}{// Calculate r(0)}
112     feti\_op.calculate\_initial\_r();
113 
114     \textcolor{comment}{// Calculate p(0)}
115     feti\_op.calculate\_initial\_p();
116 
117     \textcolor{comment}{// Calculations needed if we are using the rigid body modes}
118     \textcolor{keywordflow}{if}(input\_params.\hyperlink{structcarl_1_1feti__setup__finish__params_a4226249254863225438b36c9c2f47615}{bUseRigidBodyModes})
119     \{
120         \textcolor{comment}{// Calculate the rigid body modes correction RB\_corr}
121         feti\_op.calculate\_rb\_correction();
122     \}
123 
124     \textcolor{comment}{// --- Export output vectors!}
125     \textcolor{comment}{// Export 'r(0)' and 'p(0)'}
126     feti\_op.export\_inital\_vecs();
127 
128     \textcolor{comment}{// Export the Ct\_i * p(0) vectors}
129     feti\_op.export\_ext\_solver\_rhs\_initial();
130 
131     \textcolor{comment}{// Export the scalar data, rho(0) and, if pertinent, |RB\_corr|}
132     feti\_op.export\_initial\_scalar\_data();
133 
134     \textcolor{comment}{// --- Launch the "iter\_script.sh" script --- ONLY ON THE FIRST PROC!}
135     \textcolor{keywordflow}{if}(WorldComm.rank() == 0)
136     \{
137         std::string iter\_script\_command = \textcolor{stringliteral}{". "} + input\_params.
      \hyperlink{structcarl_1_1feti__setup__finish__params_ac8490d7133284997e9497f13c75ed1bd}{scratch\_folder\_path} + \textcolor{stringliteral}{"/FETI\_iter\_script.sh"};
138         \textcolor{keywordflow}{if}(input\_params.\hyperlink{structcarl_1_1feti__setup__finish__params_a30e2fbb1ab52dbbce37968be8e6f95b1}{scheduler} == \hyperlink{namespacecarl_a67066fdf35a0c326f5147098c0cf45d1a2bec097bc495ac4aacc355d3283f4b93}{carl::ClusterSchedulerType::LOCAL}
      )
139         \{
140             std::cout << \textcolor{stringliteral}{" !!! LOCAL test: MPI commands cannot be launched recursivelly !!! "} << std::endl;
141             std::cout << \textcolor{stringliteral}{"     Run the following program by hand: "} << std::endl;
142             std::cout << iter\_script\_command << std::endl;
143         \} \textcolor{keywordflow}{else} \{
144             \hyperlink{namespacecarl_a54249fee021b3d53e1a7ae7208292437}{carl::exec\_command}(iter\_script\_command);
145         \}
146     \}
147 
148     \textcolor{keywordflow}{return} 0;
149 \}
\end{DoxyCode}

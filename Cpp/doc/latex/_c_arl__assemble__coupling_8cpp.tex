\hypertarget{_c_arl__assemble__coupling_8cpp}{}\section{/\+Users/breubreubreu/\+Programming/\+C\+Arl/\+Cpp/src/execs/\+C\+Arl\+\_\+tools/\+C\+Arl\+\_\+assemble\+\_\+coupling.cpp File Reference}
\label{_c_arl__assemble__coupling_8cpp}\index{/\+Users/breubreubreu/\+Programming/\+C\+Arl/\+Cpp/src/execs/\+C\+Arl\+\_\+tools/\+C\+Arl\+\_\+assemble\+\_\+coupling.\+cpp@{/\+Users/breubreubreu/\+Programming/\+C\+Arl/\+Cpp/src/execs/\+C\+Arl\+\_\+tools/\+C\+Arl\+\_\+assemble\+\_\+coupling.\+cpp}}


Implementation of the parallel coupling matrices assembly.  


{\ttfamily \#include \char`\"{}C\+Arl\+\_\+assemble\+\_\+coupling.\+h\char`\"{}}\\*
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
lib\+Mesh\+::\+Explicit\+System \& \hyperlink{_c_arl__assemble__coupling_8cpp_a9f615ae4cf0cefe20b5e5b94c9514b09}{add\+\_\+explicit\+\_\+elasticity} (lib\+Mesh\+::\+Equation\+Systems \&input\+\_\+systems, lib\+Mesh\+::\+Order order=lib\+Mesh\+::\+F\+I\+R\+S\+T, lib\+Mesh\+::\+F\+E\+Family family=lib\+Mesh\+::\+L\+A\+G\+R\+A\+N\+G\+E)
\item 
lib\+Mesh\+::\+Implicit\+System \& \hyperlink{_c_arl__assemble__coupling_8cpp_a1fab87d9dc5c891ae8234cec6cf73491}{add\+\_\+elasticity} (lib\+Mesh\+::\+Equation\+Systems \&input\+\_\+systems, lib\+Mesh\+::\+Order order=lib\+Mesh\+::\+F\+I\+R\+S\+T, lib\+Mesh\+::\+F\+E\+Family family=lib\+Mesh\+::\+L\+A\+G\+R\+A\+N\+G\+E)
\begin{DoxyCompactList}\small\item\em Add a linear elasticity lib\+Mesh\+::\+Linear\+Implicit\+System to the input lib\+Mesh\+::\+Equation\+Systems\& input\+\_\+systems. \end{DoxyCompactList}\item 
int \hyperlink{_c_arl__assemble__coupling_8cpp_a3c04138a5bfe5d72780bb7e82a18e627}{main} (int argc, char $\ast$$\ast$argv)
\end{DoxyCompactItemize}


\subsection{Detailed Description}
Implementation of the parallel coupling matrices assembly. 

Usage\+: {\ttfamily ./\+C\+Arl\+\_\+assemble\+\_\+coupling -\/i \mbox{[}input file\mbox{]}}

This program uses the intersections previously constructed to build the couplig matrices. The input file is parsed by the carl\+::get\+\_\+input\+\_\+params(\+Get\+Pot\& field\+\_\+parser, coupling\+\_\+assemble\+\_\+coupling\+\_\+input\+\_\+params\& input\+\_\+params) function, and it contains the following parameters.

Required parameters\+:
\begin{DoxyItemize}
\item System and intersection meshes\+:
\begin{DoxyItemize}
\item {\ttfamily Mesh\+A}, {\ttfamily -\/m\+A} or {\ttfamily -\/-\/mesh\+A} \+: path to the mesh A.
\item {\ttfamily Mesh\+B}, {\ttfamily -\/m\+B} or {\ttfamily -\/-\/mesh\+B} \+: path to the mesh B.
\item {\ttfamily Inter\+Base}, {\ttfamily -\/m\+I} or {\ttfamily -\/-\/mesh\+I} \+: common path to the intersection meshes and tables.
\end{DoxyItemize}
\item Coupling parameters\+:
\begin{DoxyItemize}
\item {\ttfamily Coupling\+Width} or {\ttfamily -\/-\/ce} \+: width of the coupling region (same unit as the meshes, $e$ in the $L_2$ coupling term).
\item {\ttfamily Coupling\+Rigidity} or {\ttfamily -\/-\/ck} \+: rigidity used for the coupling matrix (in M\+Pa, if mm was used for the meshes, $\kappa$ in both the $L_2$ and $H_1$ terms).
\end{DoxyItemize}
\end{DoxyItemize}

Optional parameters\+:
\begin{DoxyItemize}
\item Output\+:
\begin{DoxyItemize}
\item {\ttfamily Output\+Folder} or {\ttfamily -\/-\/output} \+: base of the output folder. {\itshape Default}\+: \char`\"{}\char`\"{}.
\end{DoxyItemize}
\item Restriction meshes and tables\+:
\begin{DoxyItemize}
\item {\ttfamily Mesh\+\_\+\+A\+\_\+\+Restriction}, {\ttfamily -\/m\+A\+R} or {\ttfamily -\/-\/mesh\+A\+R} \+: path to the restricted mesh A (formed by elements of the mesh A intersecting the coupling region). {\itshape Default}\+: {\ttfamily \mbox{[}Inter\+Base\mbox{]}\+\_\+\+A\+\_\+restriction.\+msh}.
\item {\ttfamily Mesh\+\_\+\+B\+\_\+\+Restriction}, {\ttfamily -\/m\+B\+R} or {\ttfamily -\/-\/mesh\+B\+R} \+: path to the restricted mesh B (formed by elements of the mesh A intersecting the coupling region). {\itshape Default}\+: {\ttfamily \mbox{[}Inter\+Base\mbox{]}\+\_\+\+B\+\_\+restriction.\+msh}.
\begin{DoxyItemize}
\item {\ttfamily Mesh\+\_\+\+A\+\_\+\+Restriction\+Equivalence\+Table} or {\ttfamily -\/-\/table\+R\+A} \+: path to the equivalence table between the mesh A and its restriction. {\itshape Default}\+: {\ttfamily \mbox{[}Inter\+Base\mbox{]}\+\_\+\+A\+\_\+restriction\+\_\+restrict.\+dat}.
\item {\ttfamily Mesh\+\_\+\+B\+\_\+\+Restriction\+Equivalence\+Table} or {\ttfamily -\/-\/table\+R\+B} \+: path to the equivalence table between the mesh B and its restriction. {\itshape Default}\+: {\ttfamily \mbox{[}Inter\+Base\mbox{]}\+\_\+\+B\+\_\+restriction\+\_\+restrict.\+dat}.
\end{DoxyItemize}
\end{DoxyItemize}
\item Mediator mesh\+:
\begin{DoxyItemize}
\item {\ttfamily Mediator\+Mesh} \+: choice of the mediator mesh. {\itshape Values}\+: {\ttfamily Use\+Restricted\+\_\+\+A} or {\ttfamily Use\+Restricted\+\_\+\+B}. {\itshape Default}\+: {\ttfamily Use\+Restricted\+\_\+\+A}. 
\end{DoxyItemize}
\end{DoxyItemize}

\subsection{Function Documentation}
\hypertarget{_c_arl__assemble__coupling_8cpp_a1fab87d9dc5c891ae8234cec6cf73491}{}\index{C\+Arl\+\_\+assemble\+\_\+coupling.\+cpp@{C\+Arl\+\_\+assemble\+\_\+coupling.\+cpp}!add\+\_\+elasticity@{add\+\_\+elasticity}}
\index{add\+\_\+elasticity@{add\+\_\+elasticity}!C\+Arl\+\_\+assemble\+\_\+coupling.\+cpp@{C\+Arl\+\_\+assemble\+\_\+coupling.\+cpp}}
\subsubsection[{add\+\_\+elasticity(lib\+Mesh\+::\+Equation\+Systems \&input\+\_\+systems, lib\+Mesh\+::\+Order order=lib\+Mesh\+::\+F\+I\+R\+S\+T, lib\+Mesh\+::\+F\+E\+Family family=lib\+Mesh\+::\+L\+A\+G\+R\+A\+N\+G\+E)}]{\setlength{\rightskip}{0pt plus 5cm}lib\+Mesh\+::\+Implicit\+System\& add\+\_\+elasticity (
\begin{DoxyParamCaption}
\item[{lib\+Mesh\+::\+Equation\+Systems \&}]{input\+\_\+systems, }
\item[{lib\+Mesh\+::\+Order}]{order = {\ttfamily libMesh\+:\+:FIRST}, }
\item[{lib\+Mesh\+::\+F\+E\+Family}]{family = {\ttfamily libMesh\+:\+:LAGRANGE}}
\end{DoxyParamCaption}
)}\label{_c_arl__assemble__coupling_8cpp_a1fab87d9dc5c891ae8234cec6cf73491}


Add a linear elasticity lib\+Mesh\+::\+Linear\+Implicit\+System to the input lib\+Mesh\+::\+Equation\+Systems\& input\+\_\+systems. 



Definition at line 48 of file C\+Arl\+\_\+assemble\+\_\+coupling.\+cpp.


\begin{DoxyCode}
51 \{
52     libMesh::ImplicitSystem& elasticity\_system =
53             input\_systems.add\_system<libMesh::ImplicitSystem> (\textcolor{stringliteral}{"Elasticity"});
54 
55     elasticity\_system.add\_variable(\textcolor{stringliteral}{"u"}, order, family);
56     elasticity\_system.add\_variable(\textcolor{stringliteral}{"v"}, order, family);
57     elasticity\_system.add\_variable(\textcolor{stringliteral}{"w"}, order, family);
58 
59     \textcolor{keywordflow}{return} elasticity\_system;
60 \}
\end{DoxyCode}
\hypertarget{_c_arl__assemble__coupling_8cpp_a9f615ae4cf0cefe20b5e5b94c9514b09}{}\index{C\+Arl\+\_\+assemble\+\_\+coupling.\+cpp@{C\+Arl\+\_\+assemble\+\_\+coupling.\+cpp}!add\+\_\+explicit\+\_\+elasticity@{add\+\_\+explicit\+\_\+elasticity}}
\index{add\+\_\+explicit\+\_\+elasticity@{add\+\_\+explicit\+\_\+elasticity}!C\+Arl\+\_\+assemble\+\_\+coupling.\+cpp@{C\+Arl\+\_\+assemble\+\_\+coupling.\+cpp}}
\subsubsection[{add\+\_\+explicit\+\_\+elasticity(lib\+Mesh\+::\+Equation\+Systems \&input\+\_\+systems, lib\+Mesh\+::\+Order order=lib\+Mesh\+::\+F\+I\+R\+S\+T, lib\+Mesh\+::\+F\+E\+Family family=lib\+Mesh\+::\+L\+A\+G\+R\+A\+N\+G\+E)}]{\setlength{\rightskip}{0pt plus 5cm}lib\+Mesh\+::\+Explicit\+System\& add\+\_\+explicit\+\_\+elasticity (
\begin{DoxyParamCaption}
\item[{lib\+Mesh\+::\+Equation\+Systems \&}]{input\+\_\+systems, }
\item[{lib\+Mesh\+::\+Order}]{order = {\ttfamily libMesh\+:\+:FIRST}, }
\item[{lib\+Mesh\+::\+F\+E\+Family}]{family = {\ttfamily libMesh\+:\+:LAGRANGE}}
\end{DoxyParamCaption}
)}\label{_c_arl__assemble__coupling_8cpp_a9f615ae4cf0cefe20b5e5b94c9514b09}


Definition at line 34 of file C\+Arl\+\_\+assemble\+\_\+coupling.\+cpp.


\begin{DoxyCode}
37 \{
38     libMesh::ExplicitSystem& elasticity\_system =
39             input\_systems.add\_system<libMesh::ExplicitSystem> (\textcolor{stringliteral}{"Elasticity"});
40 
41     elasticity\_system.add\_variable(\textcolor{stringliteral}{"u"}, order, family);
42     elasticity\_system.add\_variable(\textcolor{stringliteral}{"v"}, order, family);
43     elasticity\_system.add\_variable(\textcolor{stringliteral}{"w"}, order, family);
44 
45     \textcolor{keywordflow}{return} elasticity\_system;
46 \}
\end{DoxyCode}
\hypertarget{_c_arl__assemble__coupling_8cpp_a3c04138a5bfe5d72780bb7e82a18e627}{}\index{C\+Arl\+\_\+assemble\+\_\+coupling.\+cpp@{C\+Arl\+\_\+assemble\+\_\+coupling.\+cpp}!main@{main}}
\index{main@{main}!C\+Arl\+\_\+assemble\+\_\+coupling.\+cpp@{C\+Arl\+\_\+assemble\+\_\+coupling.\+cpp}}
\subsubsection[{main(int argc, char $\ast$$\ast$argv)}]{\setlength{\rightskip}{0pt plus 5cm}int main (
\begin{DoxyParamCaption}
\item[{int}]{argc, }
\item[{char $\ast$$\ast$}]{argv}
\end{DoxyParamCaption}
)}\label{_c_arl__assemble__coupling_8cpp_a3c04138a5bfe5d72780bb7e82a18e627}


Definition at line 62 of file C\+Arl\+\_\+assemble\+\_\+coupling.\+cpp.


\begin{DoxyCode}
62                                 \{
63 
64     \textcolor{comment}{// --- Initialize libMesh}
65     libMesh::LibMeshInit init(argc, argv);
66 
67     \textcolor{comment}{// Do performance log?}
68     \textcolor{keyword}{const} \textcolor{keywordtype}{bool} MASTER\_bPerfLog\_carl\_libmesh = \textcolor{keyword}{true};
69     libMesh::PerfLog perf\_log(\textcolor{stringliteral}{"Main program"}, MASTER\_bPerfLog\_carl\_libmesh);
70 
71     \textcolor{comment}{// libMesh's C++ / MPI communicator wrapper}
72     libMesh::Parallel::Communicator& WorldComm = init.comm();
73 
74     \textcolor{comment}{// Number of processors and processor rank.}
75     \textcolor{keywordtype}{int} rank = WorldComm.rank();
76     \textcolor{keywordtype}{int} nodes = WorldComm.size();
77 
78     \textcolor{comment}{// Create local communicator}
79     libMesh::Parallel::Communicator LocalComm;
80     WorldComm.split(rank,rank,LocalComm);
81 
82     \textcolor{comment}{// --- Set up inputs}
83 
84     \textcolor{comment}{// Command line parser}
85     GetPot command\_line(argc, argv);
86 
87     \textcolor{comment}{// File parser}
88     GetPot field\_parser;
89 
90     \textcolor{comment}{// If there is an input file, parse it to get the parameters. Else, parse the command line}
91     std::string input\_filename;
92     \textcolor{keywordflow}{if} (command\_line.search(2, \textcolor{stringliteral}{"--inputfile"}, \textcolor{stringliteral}{"-i"})) \{
93         input\_filename = command\_line.next(input\_filename);
94         field\_parser.parse\_input\_file(input\_filename, \textcolor{stringliteral}{"#"}, \textcolor{stringliteral}{"\(\backslash\)n"}, \textcolor{stringliteral}{" \(\backslash\)t\(\backslash\)n"});
95     \} \textcolor{keywordflow}{else} \{
96         field\_parser = command\_line;
97     \}
98 
99     \hyperlink{structcarl_1_1coupling__assemble__coupling__input__params}{carl::coupling\_assemble\_coupling\_input\_params} input\_params
      ;
100     \hyperlink{namespacecarl_aba5c04efa5a0abae78d3efd00ae694e3}{carl::get\_assemble\_coupling\_input\_params}(field\_parser, 
      input\_params);
101 
102     \textcolor{comment}{// Check libMesh installation dimension}
103     \textcolor{keyword}{const} \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} dim = 3;
104 
105     libmesh\_example\_requires(dim == LIBMESH\_DIM, \textcolor{stringliteral}{"3D support"});
106 
107     \textcolor{comment}{// --- Set up the meshes}
108 
109     \textcolor{comment}{// - Parallelized meshes: A, B, mediator and weight}
110     perf\_log.push(\textcolor{stringliteral}{"Meshes - Parallel"},\textcolor{stringliteral}{"Read files:"});
111     libMesh::Mesh mesh\_BIG(WorldComm, dim);
112     mesh\_BIG.read(input\_params.\hyperlink{structcarl_1_1coupling__assemble__coupling__input__params_af311a867cd2103103da6f37851832d18}{mesh\_BIG\_file});
113     mesh\_BIG.prepare\_for\_use();
114 
115     libMesh::Mesh mesh\_micro(WorldComm, dim);
116     mesh\_micro.read(input\_params.\hyperlink{structcarl_1_1coupling__assemble__coupling__input__params_a704cd64a2a6e9c980a46130bc9ec921b}{mesh\_micro\_file});
117     mesh\_micro.prepare\_for\_use();
118 
119     libMesh::Mesh mesh\_mediator(WorldComm, dim);
120     mesh\_mediator.allow\_renumbering(\textcolor{keyword}{false});
121     mesh\_mediator.read(input\_params.\hyperlink{structcarl_1_1coupling__assemble__coupling__input__params_a4fa79c1dc75b71bbda8e54d351ede2d2}{mesh\_mediator\_file});
122     mesh\_mediator.prepare\_for\_use();
123 
124     perf\_log.pop(\textcolor{stringliteral}{"Meshes - Parallel"},\textcolor{stringliteral}{"Read files:"});
125 
126     \textcolor{comment}{// - Local meshes: restrict A and restrict B}
127 
128     \textcolor{comment}{// -> libMesh's default mesh IS the ReplicatedMesh, which creates a copy of}
129     \textcolor{comment}{//    itself on each processor, but partitions the iterators over each}
130     \textcolor{comment}{//    processor to allow the parallelization of the code. The usage of}
131     \textcolor{comment}{//    ParallelMesh is still a bit risky, and, performance-wise, is worse}
132     \textcolor{comment}{//    than ReplicatedMesh for less than a few thousand processors.}
133 
134     perf\_log.push(\textcolor{stringliteral}{"Meshes - Serial"},\textcolor{stringliteral}{"Read files:"});
135     libMesh::ReplicatedMesh mesh\_R\_BIG(WorldComm, dim);
136     mesh\_R\_BIG.allow\_renumbering(\textcolor{keyword}{false});
137     mesh\_R\_BIG.read(input\_params.\hyperlink{structcarl_1_1coupling__assemble__coupling__input__params_ad2f08c3035377449238a1d830c666630}{mesh\_restrict\_BIG\_file});
138     mesh\_R\_BIG.prepare\_for\_use();
139 
140     libMesh::ReplicatedMesh mesh\_R\_micro(WorldComm, dim);
141     mesh\_R\_micro.allow\_renumbering(\textcolor{keyword}{false});
142     mesh\_R\_micro.read(input\_params.\hyperlink{structcarl_1_1coupling__assemble__coupling__input__params_ab73f9619bf9653bd3ed2cd019dff5f04}{mesh\_restrict\_micro\_file});
143     mesh\_R\_micro.prepare\_for\_use();
144 
145     \textcolor{comment}{// - Local mesh: intersection mesh}
146     libMesh::Mesh mesh\_inter(LocalComm, dim);
147     mesh\_inter.allow\_renumbering(\textcolor{keyword}{false});
148     std::string local\_inter\_mesh\_filename = input\_params.\hyperlink{structcarl_1_1coupling__assemble__coupling__input__params_aa922a4b0252168abcfd52a9eb3e2b796}{common\_inter\_file} + \textcolor{stringliteral}{"\_r\_"}
149                                         + std::to\_string(rank) + \textcolor{stringliteral}{"\_n\_"} + std::to\_string(nodes) + \textcolor{stringliteral}{".e"};
150     std::string local\_inter\_table\_filename = input\_params.\hyperlink{structcarl_1_1coupling__assemble__coupling__input__params_aa922a4b0252168abcfd52a9eb3e2b796}{common\_inter\_file} + \textcolor{stringliteral}{"\_r\_"}
151                                         + std::to\_string(rank) + \textcolor{stringliteral}{"\_n\_"} + std::to\_string(nodes) + \textcolor{stringliteral}{"
      \_inter\_table\_Full.dat"};
152     std::string global\_inter\_table\_filename = input\_params.\hyperlink{structcarl_1_1coupling__assemble__coupling__input__params_aa922a4b0252168abcfd52a9eb3e2b796}{common\_inter\_file} + \textcolor{stringliteral}{"
      \_stitched\_inter\_table\_Full.dat"};
153 
154     mesh\_inter.read(local\_inter\_mesh\_filename);
155     mesh\_inter.prepare\_for\_use();
156 
157     perf\_log.pop(\textcolor{stringliteral}{"Meshes - Serial"},\textcolor{stringliteral}{"Read files:"});
158 
159     \textcolor{comment}{// --- Prepare the equivalence tables and the intersection mappings}
160     perf\_log.push(\textcolor{stringliteral}{"Equivalence / intersection tables"},\textcolor{stringliteral}{"Read files:"});
161 
162     \textcolor{comment}{// Local intersection pairs (system meshes)}
163     std::unordered\_map<int,std::pair<int,int> > local\_intersection\_pairs\_map;
164 
165     \textcolor{comment}{// Local intersection pairs (restricted meshes)}
166     std::unordered\_map<int,std::pair<int,int> > local\_intersection\_restricted\_pairs\_map;
167 
168     \textcolor{comment}{// Intersection elements to be treated by this processor}
169     std::unordered\_map<int,int> local\_intersection\_meshI\_to\_inter\_map;
170 
171     \textcolor{comment}{// Equivalence tables between system and restricted meshes (and vice-versa)}
172     std::unordered\_map<int,int> equivalence\_table\_BIG\_to\_R\_BIG;
173     std::unordered\_map<int,int> equivalence\_table\_micro\_to\_R\_micro;
174     std::unordered\_map<int,int> equivalence\_table\_R\_BIG\_to\_BIG;
175     std::unordered\_map<int,int> equivalence\_table\_R\_micro\_to\_micro;
176 
177     \textcolor{comment}{//  Start by reading and broadcasting the equivalence tables}
178     \hyperlink{namespacecarl_a995bb6a3c01d8cede8268c2f39ce0768}{carl::set\_equivalence\_tables}(
179             WorldComm,
180             input\_params.\hyperlink{structcarl_1_1coupling__assemble__coupling__input__params_a38e203a052eb26245cc22e80084464dd}{equivalence\_table\_restrict\_BIG\_file},
181             input\_params.\hyperlink{structcarl_1_1coupling__assemble__coupling__input__params_a07948e27f6a1a82cffbd1780f28350c7}{equivalence\_table\_restrict\_micro\_file},
182 
183             equivalence\_table\_BIG\_to\_R\_BIG,
184             equivalence\_table\_micro\_to\_R\_micro,
185             equivalence\_table\_R\_BIG\_to\_BIG,
186             equivalence\_table\_R\_micro\_to\_micro);
187 
188     \textcolor{comment}{// Set the local intersection tables}
189     \textcolor{keywordflow}{if}(input\_params.\hyperlink{structcarl_1_1coupling__assemble__coupling__input__params_aa520455b2876272ffc924f060f2a332a}{mediator\_type} == \hyperlink{namespacecarl_ab4549821791d976a4bb9a3460fe1718eae0a6a4791f68baefa4702e4f053b2817}{carl::MediatorType::USE\_MACRO}
      )
190     \{
191         \hyperlink{namespacecarl_a8d1c90daac3238ed5d53465740e072b3}{carl::set\_local\_intersection\_tables}(
192                 WorldComm,
193                 mesh\_inter,
194                 local\_inter\_table\_filename,
195                 input\_params.\hyperlink{structcarl_1_1coupling__assemble__coupling__input__params_a38e203a052eb26245cc22e80084464dd}{equivalence\_table\_restrict\_BIG\_file},
196                 input\_params.\hyperlink{structcarl_1_1coupling__assemble__coupling__input__params_a07948e27f6a1a82cffbd1780f28350c7}{equivalence\_table\_restrict\_micro\_file},
197 
198                 equivalence\_table\_BIG\_to\_R\_BIG,
199                 equivalence\_table\_micro\_to\_R\_micro,
200 
201                 local\_intersection\_pairs\_map,
202                 local\_intersection\_restricted\_pairs\_map,
203                 local\_intersection\_meshI\_to\_inter\_map);
204     \}
205     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(input\_params.\hyperlink{structcarl_1_1coupling__assemble__coupling__input__params_aa520455b2876272ffc924f060f2a332a}{mediator\_type} == 
      \hyperlink{namespacecarl_ab4549821791d976a4bb9a3460fe1718eaaeaede2dff7ae7d5633a316f0fbc3151}{carl::MediatorType::USE\_MICRO})
206     \{
207         \hyperlink{namespacecarl_a8d1c90daac3238ed5d53465740e072b3}{carl::set\_local\_intersection\_tables}(
208                 WorldComm,
209                 mesh\_inter,
210                 local\_inter\_table\_filename,
211                 input\_params.\hyperlink{structcarl_1_1coupling__assemble__coupling__input__params_a07948e27f6a1a82cffbd1780f28350c7}{equivalence\_table\_restrict\_micro\_file},
212                 input\_params.\hyperlink{structcarl_1_1coupling__assemble__coupling__input__params_a38e203a052eb26245cc22e80084464dd}{equivalence\_table\_restrict\_BIG\_file},
213 
214                 equivalence\_table\_micro\_to\_R\_micro,
215                 equivalence\_table\_BIG\_to\_R\_BIG,
216 
217                 local\_intersection\_pairs\_map,
218                 local\_intersection\_restricted\_pairs\_map,
219                 local\_intersection\_meshI\_to\_inter\_map);
220     \}
221 
222     \textcolor{comment}{// Build mappings with the intersections of the mediator mesh with the micro and macro meshes - used to
       preallocate the coupling matrices}
223     std::unordered\_multimap<int,int> inter\_mediator\_BIG;
224     std::unordered\_multimap<int,int> inter\_mediator\_micro;
225     \hyperlink{namespacecarl_ab4df2c3a7c53c68fc2628569f4b4bd17}{carl::set\_global\_mediator\_system\_intersection\_lists}(
226             WorldComm,
227             global\_inter\_table\_filename,
228             equivalence\_table\_BIG\_to\_R\_BIG,
229             equivalence\_table\_R\_BIG\_to\_BIG,
230             inter\_mediator\_BIG,
231             inter\_mediator\_micro);
232     perf\_log.pop(\textcolor{stringliteral}{"Equivalence / intersection tables"},\textcolor{stringliteral}{"Read files:"});
233 
234     \textcolor{comment}{// --- Generate the equation systems}
235     perf\_log.push(\textcolor{stringliteral}{"Initialization"},\textcolor{stringliteral}{"System initialization:"});
236     \hyperlink{classcarl_1_1assemble__coupling__matrices}{carl::assemble\_coupling\_matrices} CoupledMatrices(WorldComm);
237 
238     libMesh::EquationSystems& equation\_systems\_inter =
239                     CoupledMatrices.add\_inter\_EquationSystem(\textcolor{stringliteral}{"InterSys"}, mesh\_inter);
240 
241     libMesh::ExplicitSystem& elasticity\_system\_inter
242                                         = \hyperlink{_c_arl__assemble__coupling_8cpp_a9f615ae4cf0cefe20b5e5b94c9514b09}{add\_explicit\_elasticity}(
      equation\_systems\_inter);
243 
244     \hyperlink{namespacecarl_a8b8d75f4ab54390f3e7c607ed4f0cf19}{carl::reduced\_system\_init}(elasticity\_system\_inter);
245 
246     perf\_log.pop(\textcolor{stringliteral}{"Initialization"},\textcolor{stringliteral}{"System initialization:"});
247 
248     \textcolor{comment}{// - Build the MACRO system}
249 
250     perf\_log.push(\textcolor{stringliteral}{"Macro system"},\textcolor{stringliteral}{"System initialization:"});
251     libMesh::EquationSystems& equation\_systems\_BIG =
252                     CoupledMatrices.set\_BIG\_EquationSystem(\textcolor{stringliteral}{"BigSys"}, mesh\_BIG);
253 
254     \textcolor{comment}{// [MACRO] Set up the physical properties}
255     libMesh::ExplicitSystem& elasticity\_system\_BIG
256                                         = \hyperlink{_c_arl__assemble__coupling_8cpp_a9f615ae4cf0cefe20b5e5b94c9514b09}{add\_explicit\_elasticity}(
      equation\_systems\_BIG);
257 
258     \hyperlink{namespacecarl_a8b8d75f4ab54390f3e7c607ed4f0cf19}{carl::reduced\_system\_init}(elasticity\_system\_BIG);
259     perf\_log.pop(\textcolor{stringliteral}{"Macro system"},\textcolor{stringliteral}{"System initialization:"});
260 
261     \textcolor{comment}{// - Build the micro system}
262 
263     perf\_log.push(\textcolor{stringliteral}{"Micro system"},\textcolor{stringliteral}{"System initialization:"});
264     libMesh::EquationSystems& equation\_systems\_micro =
265                     CoupledMatrices.add\_micro\_EquationSystem<libMesh::PetscMatrix<libMesh::Number> >(\textcolor{stringliteral}{"
      MicroSys"}, mesh\_micro);
266 
267     \textcolor{comment}{// [MICRO] Set up the physical properties}
268     libMesh::ExplicitSystem& elasticity\_system\_micro
269                                         = \hyperlink{_c_arl__assemble__coupling_8cpp_a9f615ae4cf0cefe20b5e5b94c9514b09}{add\_explicit\_elasticity}(
      equation\_systems\_micro);
270 
271     \hyperlink{namespacecarl_a8b8d75f4ab54390f3e7c607ed4f0cf19}{carl::reduced\_system\_init}(elasticity\_system\_micro);
272     perf\_log.pop(\textcolor{stringliteral}{"Micro system"},\textcolor{stringliteral}{"System initialization:"});
273 
274     \textcolor{comment}{// - Build the RESTRICTED BIG system}
275     perf\_log.push(\textcolor{stringliteral}{"RESTRICTED macro system"},\textcolor{stringliteral}{"System initialization:"});
276     libMesh::EquationSystems& equation\_systems\_R\_BIG =
277                     CoupledMatrices.set\_Restricted\_BIG\_EquationSystem(\textcolor{stringliteral}{"BigSys"}, mesh\_R\_BIG);
278 
279     \textcolor{comment}{// [R. MACRO] Set up the physical properties}
280     libMesh::ExplicitSystem& elasticity\_system\_R\_BIG
281                                         = \hyperlink{_c_arl__assemble__coupling_8cpp_a9f615ae4cf0cefe20b5e5b94c9514b09}{add\_explicit\_elasticity}(
      equation\_systems\_R\_BIG);
282 
283     \hyperlink{namespacecarl_a8b8d75f4ab54390f3e7c607ed4f0cf19}{carl::reduced\_system\_init}(elasticity\_system\_R\_BIG);
284 
285     perf\_log.pop(\textcolor{stringliteral}{"RESTRICTED macro system"},\textcolor{stringliteral}{"System initialization:"});
286 
287     \textcolor{comment}{// - Build the RESTRICTED micro system}
288 
289     perf\_log.push(\textcolor{stringliteral}{"RESTRICTED micro system"},\textcolor{stringliteral}{"System initialization:"});
290     libMesh::EquationSystems& equation\_systems\_R\_micro =
291                     CoupledMatrices.add\_Restricted\_micro\_EquationSystem(\textcolor{stringliteral}{"MicroSys"}, mesh\_R\_micro);
292 
293     \textcolor{comment}{// [R. MICRO] Set up the physical properties}
294     libMesh::ExplicitSystem& elasticity\_system\_R\_micro
295                                         = \hyperlink{_c_arl__assemble__coupling_8cpp_a9f615ae4cf0cefe20b5e5b94c9514b09}{add\_explicit\_elasticity}(
      equation\_systems\_R\_micro);
296 
297     \hyperlink{namespacecarl_a8b8d75f4ab54390f3e7c607ed4f0cf19}{carl::reduced\_system\_init}(elasticity\_system\_R\_micro);
298     perf\_log.pop(\textcolor{stringliteral}{"RESTRICTED micro system"},\textcolor{stringliteral}{"System initialization:"});
299 
300     \textcolor{comment}{// - Build the mediator system}
301 
302     perf\_log.push(\textcolor{stringliteral}{"Mediator system"},\textcolor{stringliteral}{"System initialization:"});
303     libMesh::EquationSystems& equation\_systems\_mediator =
304                     CoupledMatrices.add\_mediator\_EquationSystem(\textcolor{stringliteral}{"MediatorSys"}, mesh\_mediator);
305 
306     libMesh::ExplicitSystem& elasticity\_system\_mediator
307                                         = \hyperlink{_c_arl__assemble__coupling_8cpp_a9f615ae4cf0cefe20b5e5b94c9514b09}{add\_explicit\_elasticity}(
      equation\_systems\_mediator);
308 
309     \hyperlink{namespacecarl_a8b8d75f4ab54390f3e7c607ed4f0cf19}{carl::reduced\_system\_init}(elasticity\_system\_mediator);
310 
311     perf\_log.pop(\textcolor{stringliteral}{"Mediator system"},\textcolor{stringliteral}{"System initialization:"});
312 
313     \textcolor{comment}{// Set parameters}
314     CoupledMatrices.set\_coupling\_parameters(\textcolor{stringliteral}{"MicroSys"},input\_params.
      \hyperlink{structcarl_1_1coupling__assemble__coupling__input__params_a9f0e82658b0e37c16faed3bc3a176dc1}{coupling\_rigidity},input\_params.\hyperlink{structcarl_1_1coupling__assemble__coupling__input__params_a2cfb03a4663c3c6bc494a88084000249}{coupling\_width});
315 
316     \textcolor{comment}{// Use H1 norm}
317     CoupledMatrices.use\_H1\_coupling(\textcolor{stringliteral}{"MicroSys"});
318 
319     \textcolor{comment}{// Assemble!}
320     CoupledMatrices.assemble\_coupling\_elasticity\_3D\_parallel(\textcolor{stringliteral}{"BigSys"},\textcolor{stringliteral}{"MicroSys"},
321             \textcolor{stringliteral}{"InterSys"},\textcolor{stringliteral}{"MediatorSys"},
322             mesh\_R\_BIG, mesh\_R\_micro,
323             local\_intersection\_pairs\_map,
324             local\_intersection\_restricted\_pairs\_map,
325             local\_intersection\_meshI\_to\_inter\_map,
326             inter\_mediator\_BIG,
327             inter\_mediator\_micro);
328 
329     \textcolor{comment}{// Print matrices!}
330     \textcolor{keywordflow}{if}(rank == 0)
331     \{
332         std::string command\_string = \textcolor{stringliteral}{"mkdir -p "} + input\_params.\hyperlink{structcarl_1_1coupling__assemble__coupling__input__params_a1344edd32f644b03b19a499e47fb1ca4}{output\_folder};
333         \hyperlink{namespacecarl_a54249fee021b3d53e1a7ae7208292437}{carl::exec\_command}(command\_string.c\_str());
334     \}
335     WorldComm.barrier();
336 
337 \textcolor{comment}{// Print MatLab debugging output? Variable defined at "carl\_headers.h"}
338 \textcolor{preprocessor}{#ifdef PRINT\_MATLAB\_DEBUG}
339     CoupledMatrices.print\_matrices\_matlab(\textcolor{stringliteral}{"MicroSys"},input\_params.\hyperlink{structcarl_1_1coupling__assemble__coupling__input__params_a1344edd32f644b03b19a499e47fb1ca4}{output\_folder});
340 \textcolor{preprocessor}{#endif}
341     CoupledMatrices.print\_PETSC\_matrices(\textcolor{stringliteral}{"MicroSys"},input\_params.\hyperlink{structcarl_1_1coupling__assemble__coupling__input__params_a1344edd32f644b03b19a499e47fb1ca4}{output\_folder});
342 
343     \textcolor{keywordflow}{return} 0;
344 \}
\end{DoxyCode}
